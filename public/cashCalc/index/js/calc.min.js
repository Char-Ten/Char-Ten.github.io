(function(){var t={"公共支出":"publicCash","比例支出":"ratioCash","参与比例":"ratio"};Vue.component("x-alert",{template:"#x-alert",props:["title"]});Vue.component("model-add-person",{template:"#model-addPerson",props:["focus"],data:function(){return{textValue:""}},computed:{isArrowSubmit:function(){return this.textValue}},watch:{focus:function(){if(this.focus)this.$refs["input"].focus()}},methods:{atv_Submit:function(){if(this.isArrowSubmit){this.$emit("submit",this.textValue);this.textValue=""}},atv_cancel:function(){this.textValue="";this.$emit("cancel")}},mounted:function(){this.isFocus}});Vue.component("table-view",{template:"#table-view",data:function(){return{typeIndex:t,typesCounts:{},isArrowSubmit:true}},computed:{tableData:function(){return this.$store.state.person},tableContentMaxLength:function(){var t=[0];for(var e=0;e<this.tableData.length;e++){t.push(this.tableData[e].publicCash.length);t.push(this.tableData[e].ratioCash.length);t.push(this.tableData[e].ratio.length)}return Math.max.apply(Math,t)}},methods:{atv_submitTable:function(){if(!this.isArrowSubmit){return}if(location.hostname==="char-ten.github.io"){try{var t=XLSX.utils.table_to_book(this.$refs["table"]);var e=XLSX.write(t,{type:"binary",bookType:"xlsx",bookSST:false});function n(t){var e=new ArrayBuffer(t.length);var n=new Uint8Array(e);for(var s=0;s!=t.length;++s)n[s]=t.charCodeAt(s)&255;return e}saveAs(new Blob([n(e)],{type:"application/octet-stream"}),(new Date).getTime()+".xlsx");this.isArrowSubmit=true}catch(t){console.log(t);alert("您的浏览器不支持本地生成excel的功能")}}else{this.isArrowSubmit=false;var s=new XMLHttpRequest;var i=this;s.open("post","/api/translate/htmltable2excel",true);s.onload=function(){i.isArrowSubmit=true;try{var t=JSON.parse(s.responseText);if(t.state==="ok"){var e=window.open(t.data.url,"_blank");if(!e)window.location.href=t.data.url}}catch(t){}};s.send(this.$refs["table"].innerHTML)}},calc_PersonTypesCount:function(t,e,n){var s=this.util_total(t);if(Array.isArray(this.typesCounts[e])){this.typesCounts[e][n]=s}else{this.typesCounts[e]=[s]}return s.toFixed(2)},calc_TypesCount:function(t){var e=this.util_total(this.typesCounts[t]);this.typesCounts[t+"_value"]=e;return e.toFixed(2)},calc_TypesCountAverage:function(t,e){var n=this.typesCounts[t+"_value"]||0;if(t==="ratio"){if(n===0)return 0;return(this.typesCounts[t][e]*100/n).toFixed(2)+"%"}if(t==="ratioCash"){var s=this.typesCounts["ratio_value"]||0;var i=this.typesCounts["ratio"][e]||0;var r=0;if(s!==0){r=i/s}return(this.typesCounts[t][e]-n*r).toFixed(2)}return(this.typesCounts[t][e]-n/4).toFixed(2)},util_total:function(t){if(!Array.isArray(t))return 0;if(t.length===0)return 0;return t.reduce(function(t,e){if(!isNaN(e)){return t+e}return t})}},mounted:function(){}});var e=new Vuex.Store({state:{hasPerson:{},person:[],history:[]},mutations:{addPerson:function(t,e){var n=[];if(Array.isArray(e)){e.forEach(function(e,s){if(t.hasPerson[e.name]){return}t.hasPerson[e.name]=1;n.push(e)})}else if(!t.hasPerson[e.name]){t.hasPerson[item.name]=1;n.push(item)}t.person=t.person.concat(n)},addPersonCashType:function(e,n){if(!e.hasPerson[n.name]){return}var s=t[n.type];if(Array.isArray(e.person[n.index][s])){e.person[n.index][s].push(n.value)}},removePersonItem:function(t,e){for(var n=0;n<t.person.length;n++){if(e===t.person[n].name){t.person.splice(n,1);return}}},clearPerson:function(t){t.person=[]},addHistory:function(t,e){if(Array.isArray(e)){t.history.concat(e);return}t.history.push(e)},removeHistoryItem:function(t,n){if(!t.history[n.index])return;t.history.splice(n.index,n.number);e.commit("rebuildPersonByHistory")},replaceHistoryItem:function(t,n){t.history[n.index]=n.item;e.commit("rebuildPersonByHistory")},rebuildPersonByHistory:function(e){var n={};var s=[];e.person.forEach(function(t,e){s[e]={name:t.name,publicCash:[],ratioCash:[],ratio:[]};n[t.name]=e});e.history.forEach(function(i){var r=i.split(" ");var o=r[0];var a=n[o];var u=t[r[1].replace(/[【】]/g,"")];var h=r[2]*1;if(e.hasPerson[o]){s[a][u].push(h)}else{s[a]={name:o,publicCash:[],ratioCash:[],ratio:[]};s[a][u].push(h)}});e.person=s}}});var n=new Vue({el:"#app",store:e,data:{isAddModelShow:false,typesState:["公共支出","比例支出","参与比例"],typesIndex:0,personIndex:0,inputValue:""},computed:{result:function(){var t=this.selectedPerson.name;var e="【"+this.selectedType+"】";var n=this.inputValue;return[t,e,n].join(" ")},selectedPerson:function(){return this.$store.state.person[this.personIndex]||{}},selectedType:function(){return this.typesState[this.typesIndex]},personState:function(){return this.$store.state.person},historyList:function(){return this.$store.state.history}},watch:{isAddModelShow:function(){if(!this.isAddModelShow)this.$refs["input"].focus()}},methods:{atv_ShowAddPersonModel:function(){this.isAddModelShow=true},atv_AddPerson:function(t){this.isAddModelShow=false;this.$refs["input"].focus();var n=t.split(/[,，]/).map(function(t){return{name:t,publicCash:[],ratioCash:[],ratio:[]}});e.commit("addPerson",n)},atv_KeydownInput:function(t){var e=[38,40,37,39];for(var n=0;n<e.length;n++){if(t.keyCode===e[n]){t.preventDefault();return}}},atv_SubmitInput:function(){var t=this.selectedPerson.name;var n=this.selectedType;if(!t||!n||!this.inputValue)return;e.commit("addHistory",this.result);e.commit("addPersonCashType",{name:t,type:n,value:parseFloat(this.inputValue),index:this.personIndex});this.inputValue=""},atv_TypesIndexAdd:function(t){t.preventDefault();this.typesIndex=this.util_AddValue(this.typesIndex,this.typesState.length)},atv_TypesIndexSub:function(t){t.preventDefault();this.typesIndex=this.util_SubValue(this.typesIndex,this.typesState.length)},atv_PersonIndexAdd:function(t){t.preventDefault();this.personIndex=this.util_AddValue(this.personIndex,Object.keys(this.personState).length)},atv_PersonIndexSub:function(t){t.preventDefault();this.personIndex=this.util_SubValue(this.personIndex,Object.keys(this.personState).length)},util_AddValue:function(t,e){t++;if(t>=e)t-=e;return t},util_SubValue:function(t,e){t--;if(t<0)t+=e;return t}},mounted:function(){this.$refs["input"].focus();window.addEventListener("keyup",function(t){if(t.keyCode===83||t.keyCode===40){n.atv_TypesIndexAdd(t)}if(t.keyCode===87||t.keyCode===38){n.atv_TypesIndexSub(t)}if(t.keyCode===65||t.keyCode===37){n.atv_PersonIndexSub(t)}if(t.keyCode===68||t.keyCode===39){n.atv_PersonIndexAdd(t)}if(t.ctrlKey&&t.keyCode===90){e.commit("removeHistoryItem",{index:n.historyList.length-1,number:1})}})}})})();